generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  name      String?
  isAdmin   Boolean  @default(false)
  isActive  Boolean  @default(true)

  // Google認証関連
  googleUserId String? @unique

  // Apple認証関連
  appleUserId  String? @unique

  // Google Play Store関連
  googlePlaySubscriptions GooglePlaySubscription[]

  // App Store関連
  appStoreSubscriptions  AppStoreSubscription[]

  // デバイス履歴
  deviceHistory DeviceHistory[]

  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model GooglePlaySubscription {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  subscriptionId String
  purchaseToken String
  status        String   // 'active' | 'expired' | 'cancelled'
  expiryDate    DateTime
  productId     String
  googleUserId  String
  orderId       String
  packageName   String
  lastVerifiedAt DateTime
  user          User     @relation(fields: [userId], references: [id])
  userId        String   @db.ObjectId

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model AppStoreSubscription {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  originalTransactionId String
  latestReceiptData    String
  status               String   // 'active' | 'expired' | 'cancelled'
  expiryDate           DateTime
  productId            String
  appleUserId          String
  environment          String   // 'Production' | 'Sandbox'
  lastVerifiedAt       DateTime
  user                 User     @relation(fields: [userId], references: [id])
  userId               String   @db.ObjectId

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model DeviceHistory {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  deviceId    String
  platform    String   // 'ios' | 'android'
  deviceModel String?
  osVersion   String?
  lastLoginAt DateTime
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @db.ObjectId

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
} 